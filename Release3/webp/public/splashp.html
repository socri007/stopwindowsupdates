<!DOCTYPE html>
<html lang="en" class="antialiased">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <meta name="description" content="" />
        <meta name="keywords" content="" />
        <link href="build/css/css2.css" rel="stylesheet" />
        <script src="build/js/tailwindcss.cdn.3.4.16.js"></script>
        <link rel="stylesheet" href="build/css/tailwind.css" />

        <style>
            /*Overrides for Tailwind CSS */

            /*Form fields*/


            html {
                font-family: cairo, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol",
                    "Noto Color Emoji";
                /* 1 */
                line-height: 1.5;
                /* 2 */
            }
			
            * {
                -webkit-user-select: none; /* Safari */
                -moz-user-select: none; /* Firefox */
                -ms-user-select: none; /* IE10+/Edge */
                user-select: none; /* معيار CSS */
            }

            * {
                cursor: default;
                user-select: none;
            }

            #progress {
                //height2: 11px;
                //background-color: #2497f3;
                border-radius: 4px;
                width: 0%;
                transition: width 0.7s ease-in-out; /* أضف هذه الخاصية */
            }
        </style>
        <script src="build/dist/alpine.min.js" defer></script>
        <script>
            tailwind.config = {
                darkMode: "class",
            };
        </script>
    </head>
    <body bgcolor2="#E1EAF1" onmousedown="return false" onselectstart="return false" oncopy="return false" oncut="return false" scroll="no">
        <div x-data="setup()" x-init="$refs.loading.classList.add('hidden'); setColors(color);" :class="{ 'dark': isDark}">
            <div class="flex h-screen antialiased text-gray-900 bg-[#E1EAF1] dark:bg-primary-1700 dark:text-400">
                <!-- Loading screen -->
                <div id="loadings" x-ref="loading" class="fixed inset-0 z-50 flex items-center justify-center text-2xl font-semibold dark:text-gray-900 text-white bg-gray-100 dark:bg-primary-1600" style="display2: none;">
                    .....
                </div>
                <!-- Sidebar -->
                <div class="flex-1 h-full overflow-x-hidden overflow-y-auto">
                    <div class="h-screen flex items-center justify-center p-10">
                        <div class="bg-white dark:bg-primary-1600 p-8 rounded-lg shadow-md w-full md:w-2/3">
                            <div class="flex items-center">
                                <h2 id="file-display-div" class="text-2xl font-semibold dark:text-gray-400 text-gray-400 mb-4 mr-3">Initializing</h2>
                                <h2 id="file-display" class="text-2xl font-semibold dark:text-blue-200 text-gray-700 mb-4">...</h2>
                            </div>
                            <div class="w-full h-11 bg-gray-200 rounded-md dark:bg-gray-700" style="width: 100%;">
                                <div id="progress" class="h-11 bg-[#2497F3] rounded-md dark:bg-purple-500" style="width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
		
        <script>
		
		const currentThemes = JSON.parse(window.localStorage.getItem("dark")) || false; // الوضع الحالي
					const loadingElement = document.getElementById('loadings');
					
					if(currentThemes) {
						//alert(currentThemes);
						loadingElement.classList.remove('bg-[#E1EAF1]'); // هذا هو الصنف الذي يُعطي اللون الأصلي
						loadingElement.classList.remove('text-gray-500'); // هذا هو الصنف الذي يُعطي اللون الأصلي
						loadingElement.classList.add('bg-[#232F3F]'); // يمكنك تغيير 'red' إلى أي لون آخر
						loadingElement.classList.add('text-[#57C3EA]'); // يمكنك تغيير 'red' إلى أي لون آخر
					} else {
						//loadingElement.classList.remove('bg-[#E1EAF1]'); // هذا هو الصنف الذي يُعطي اللون الأصلي
						//loadingElement.classList.remove('text-gray-500'); // هذا هو الصنف الذي يُعطي اللون الأصلي
						loadingElement.classList.add('bg-[#FFF0F5]'); // يمكنك تغيير 'red' إلى أي لون آخر
						//loadingElement.classList.add('text-[#57C3EA]'); // يمكنك تغيير 'red' إلى أي لون آخر
					}
		
            //setColors('colored'); - setColors('lite');
            const setColors = (color) => {
                //alert(color);
               // const themeToggleColoredIcon = document.getElementById("buttonColored-icon");
                //const themeToggleNormalIcon = document.getElementById("buttonNormal-icon");
                //const iHeaderDiv = document.getElementById("iHeader");
                //const listViewAllDiv = document.getElementById("listViewAllDiv"); // Replace with your element's ID

                let isDark = window.localStorage.getItem("dark");

                // التحقق من وجود القيمة وتحويلها إلى قيمة منطقية
                if (isDark !== null) {
                    isDark = JSON.parse(isDark);
                } else {
                    isDark = false; // قيمة افتراضية إذا لم تكن موجودة
                }

                //alert(color + ' - ' + isDark); // الآن يتم عرض قيمة منطقية

                //toggleShadow(color, isDark);

                const root = document.documentElement;
                root.style.setProperty("--color-primary-000", `var(--color-${color}-000)`); // primary-000
				root.style.setProperty("--color-primary-100", `var(--color-${color}-100)`); // primary-100
				root.style.setProperty("--color-primary-200", `var(--color-${color}-200)`); // primary-200
				root.style.setProperty("--color-primary-220", `var(--color-${color}-220)`); // primary-220
				root.style.setProperty("--color-primary-222", `var(--color-${color}-222)`); // primary-222
				root.style.setProperty("--color-primary-202", `var(--color-${color}-202)`); // primary-202
				root.style.setProperty("--color-primary-002", `var(--color-${color}-002)`); // primary-002
				root.style.setProperty("--color-primary-300", `var(--color-${color}-300)`); // primary-300
				root.style.setProperty("--color-primary-400", `var(--color-${color}-400)`); // primary-400
				root.style.setProperty("--color-primary-440", `var(--color-${color}-440)`); // primary-440
				root.style.setProperty("--color-primary-444", `var(--color-${color}-444)`); // primary-444
				root.style.setProperty("--color-primary-404", `var(--color-${color}-404)`); // primary-404
				root.style.setProperty("--color-primary-500", `var(--color-${color}-500)`); // primary-500
				root.style.setProperty("--color-primary-600", `var(--color-${color}-600)`); // primary-600
				root.style.setProperty("--color-primary-700", `var(--color-${color}-700)`); // primary-700
				root.style.setProperty("--color-primary-770", `var(--color-${color}-770)`); // primary-770
				root.style.setProperty("--color-primary-007", `var(--color-${color}-007)`); // primary-007
				root.style.setProperty("--color-primary-707", `var(--color-${color}-707)`); // primary-707
				root.style.setProperty("--color-primary-800", `var(--color-${color}-800)`); // primary-800
				root.style.setProperty("--color-primary-880", `var(--color-${color}-880)`); // primary-880
				root.style.setProperty("--color-primary-888", `var(--color-${color}-888)`); // primary-888
				root.style.setProperty("--color-primary-808", `var(--color-${color}-808)`); // primary-808
				root.style.setProperty("--color-primary-008", `var(--color-${color}-008)`); // primary-008
				root.style.setProperty("--color-primary-900", `var(--color-${color}-900)`); // primary-900
				root.style.setProperty("--color-primary-990", `var(--color-${color}-990)`); // primary-990
				root.style.setProperty("--color-primary-999", `var(--color-${color}-999)`); // primary-999
				root.style.setProperty("--color-primary-1000", `var(--color-${color}-1000)`); // primary-1000
				root.style.setProperty("--color-primary-1100", `var(--color-${color}-1100)`); // primary-1100
				root.style.setProperty("--color-primary-1200", `var(--color-${color}-1200)`); // primary-1200
				root.style.setProperty("--color-primary-1300", `var(--color-${color}-1300)`); // primary-1300
				root.style.setProperty("--color-primary-1400", `var(--color-${color}-1400)`); // primary-1400
				root.style.setProperty("--color-primary-1500", `var(--color-${color}-1500)`); // primary-1500
				root.style.setProperty("--color-primary-1600", `var(--color-${color}-1600)`); // primary-1600
				root.style.setProperty("--color-primary-1700", `var(--color-${color}-1700)`); // primary-1700
                this.selectedColor = color;
                window.localStorage.setItem("color", color);
                //
            };

            const setup = () => {
                const getTheme = () => {
                    if (window.localStorage.getItem("dark")) {
                        return JSON.parse(window.localStorage.getItem("dark"));
                    }

                    return !!window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches;
                };

                const setTheme = (value) => {
                    window.localStorage.setItem("dark", value);
                };

                const getColor = () => {
                    if (window.localStorage.getItem("color")) {
                        return window.localStorage.getItem("color");
                    }
                    return "light";
                };
                /*
                const updateBarChart = (on) => {
                    const data = {
                        data: randomData(),
                        backgroundColor: "rgb(207, 250, 254)",
                    };
                    if (on) {
                        barChart.data.datasets.push(data);
                        barChart.update();
                    } else {
                        barChart.data.datasets.splice(1);
                        barChart.update();
                    }
                };
				*/
                return {
                    loading: true,
                    isDark: getTheme(),
                    toggleTheme() {
                        this.isDark = !this.isDark;
                        setTheme(this.isDark);
                        // استدعاء toggleShadow هنا أيضاً عند تغيير الوضع المظلم
                        //toggleShadow(getColor(), this.isDark); // هذا هو التعديل المهم
                    },
                    setLightTheme() {
                        this.isDark = false;
                        setTheme(this.isDark);
                        // استدعاء toggleShadow هنا أيضاً عند تغيير الوضع المظلم
                        //toggleShadow(getColor(), this.isDark); // هذا هو التعديل المهم
                    },
                    setDarkTheme() {
                        this.isDark = true;
                        setTheme(this.isDark);
                        // استدعاء toggleShadow هنا أيضاً عند تغيير الوضع المظلم
                        //toggleShadow(getColor(), this.isDark); // هذا هو التعديل المهم
                    },
                    color: getColor(),
                    selectedColor: "light",
                    setColors,
                    //updateBarChart,
                };
            };

            // دالة لتبديل الوضع (Dark/Light Mode) وتحديث التخزين المحلي
            const toggleTheme = () => {
                const currentTheme = JSON.parse(window.localStorage.getItem("dark")) || false; // الوضع الحالي
                const newTheme = !currentTheme; // عكس الوضع
                window.localStorage.setItem("dark", JSON.stringify(newTheme)); // تخزين الوضع الجديد
            };

            // دالة للتحكم في ظل العناصر
            // function toggleShadow(color, isDark) {
            //     const iHeaderDiv = document.getElementById("iHeader");
            //     const listViewAllDiv = document.getElementById("listViewAllDiv");

            //     if (iHeaderDiv && listViewAllDiv) {
            //         // تحقق من وجود العناصر قبل التعديل عليها
            //         if (color === "colored" && !isDark) {
            //             //iHeaderDiv.classList.remove("shadow");
            //             //listViewAllDiv.classList.remove("shadow");
            //         } else {
            //             //iHeaderDiv.classList.add("shadow");
            //             //listViewAllDiv.classList.add("shadow");
            //         }
            //     } else {
            //         console.error("لم يتم العثور على أحد عناصر iHeader أو listViewAllDiv.");
            //     }
            // }

            function sendResultToCSharp(status, message, filesProcessed, elapsedTime) {
                const result = {
                    status: status,
                    message: message,
                    filesProcessed: filesProcessed,
                    elapsedTime: parseFloat(elapsedTime),
                };
                console.log(JSON.stringify(result)); // تحقق من البيانات المرسلة
                window.chrome.webview.postMessage(JSON.stringify(result)); // استخدام JSON.stringify()
            }

            function animateProgress(files, minDelay, maxDelay) {
                const state = {
                    index: -1,
                    progress: document.getElementById("progress"),
                    fileDisplay: document.getElementById("file-display"),
                    totalFiles: files.length,
                    startTime: Date.now(), // سجل وقت البداية
                };

                function updateProgress() {
                    if (state.index < state.totalFiles) {
                        const percent = (state.index / state.totalFiles) * 100;

                        // تحديث العرض والنص
                        state.progress.style.width = percent + "%";
                        state.fileDisplay.textContent = files[state.index];

                        // الانتقال إلى العنصر التالي بعد تأخير عشوائي
                        state.index++;
                        const delay = Math.random() * (maxDelay - minDelay) + minDelay;

                        setTimeout(updateProgress, delay);
                    } else {
                        // عند الانتهاء
                        state.progress.style.width = "100%";
                        const elapsedTimeMs = Date.now() - state.startTime; // الزمن المستغرق بالمللي ثانية
                        const elapsedTimeSeconds = (elapsedTimeMs / 1000).toFixed(1); // الزمن بالثواني مع رقم عشري واحد
                        setTimeout(() => {
                            // عرض رسالة الزمن المستغرق
                            //alert(`تم التنفيذ في ${elapsedTimeSeconds} ثانية.`);
                            sendResultToCSharp("success", "Completed", files.length, elapsedTimeSeconds);
                        }, 1500);
                    }
                }

                // بدء التقدم
                state.progress.style.width = "0%";
                state.fileDisplay.textContent = files[0];
                state.index++;
                const initialDelay = Math.random() * (maxDelay - minDelay) + minDelay;
                setTimeout(updateProgress, initialDelay);
            }

            // مثال على الاستخدام:
            //const myFiles = ["...", "settings...", "js files...", "images...", ".Net...", "theme files...", "finishing..."];
            //const minDelay = 531; // أقل تأخير بالمللي ثانية
            //const maxDelay = 999; // أقصى تأخير بالمللي ثانية
            //animateProgress(myFiles, minDelay, maxDelay);

            /*
			const otherFiles = ["file1", "file2", "file3"];
			const minDelay2 = 500;
			const maxDelay2 = 1500;
			setTimeout(()=>{
				animateProgress(otherFiles, minDelay2, maxDelay2);
			}, 3000);
			*/

            function runLoading(files, minDelay, maxDelay) {
                //alert(files);
                console.log("Files received:", files);
                console.log("Min Delay:", minDelay);
                console.log("Max Delay:", maxDelay);
                // بقية كود دالة التحميل الخاصة بك
                animateProgress(files, minDelay, maxDelay);
            }
			
			function receiveMessage(jsonMessage) {
				console.log("Message received from C#: ", jsonMessage);
				try {
					const messageObject = JSON.parse(jsonMessage);
					const status = messageObject.Status;
					const message = messageObject.message; // استلام رسالة الفشل
					const lastLoadedPageName = messageObject.LastLoadedPageName;
					const loadedCount = messageObject.LoadedCount;
					const totalCount = messageObject.TotalCount;
					const titleElement = document.getElementById('file-display-div');
					const statusElement = document.getElementById('file-display');
					const progress = document.getElementById('progress');
					if (statusElement) {
						if (status === "failed" || status === "Error" || status == "Final Failure Message") {
							titleElement.textContent = "Failed initializing ";
							statusElement.classList.remove("dark:text-gray-400");
							statusElement.classList.remove("text-gray-500");
							statusElement.classList.add("dark:text-red-400");
							statusElement.classList.add("text-red-500");
							progress.classList.remove("dark:bg-purple-500");
							progress.classList.remove("bg-blue-400");
							progress.classList.add("dark:bg-red-200");
							progress.classList.add("bg-red-200");
							files = lastLoadedPageName.replace(/,\s*$/, ""); // حذف الفاصلة وأي مسافات بيضاء بعدها
							statusElement.textContent = files; // عرض رسالة الفشل
						} else {
							statusElement.textContent = lastLoadedPageName; // عرض اسم الصفحة المحملة
						}
					}
					
					if (progress) {
						const percentage = (loadedCount / totalCount) * 100;
						progress.style.width = percentage + '%';

						if (status === "success" && percentage === 100) {
							setTimeout(() => {
								sendResultToCSharp("success", "Completed", totalCount, 0);
							}, 333);
						}
					}
				} catch (error) {
					console.error("Error parsing JSON message:", error);
				}
			}
			
			function sendResultToCSharp(status, message, filesProcessed, elapsedTime) {
				const result = {
					status: status,
					message: message,
					filesProcessed: filesProcessed,
					elapsedTime: parseFloat(elapsedTime),
				};
				console.log(JSON.stringify(result)); // تحقق من البيانات المرسلة
				window.chrome.webview.postMessage(JSON.stringify(result)); // استخدام JSON.stringify()
			}
			
			document.addEventListener("DOMContentLoaded", function () {
				//alert();
				const message = JSON.stringify({
                    type: "show.me",
                    event: "void",
                    id: "splashp",
                });
				console.log("message: " + message);
                window.chrome.webview.postMessage(message);
			});
			
        </script>
    </body>
</html>
